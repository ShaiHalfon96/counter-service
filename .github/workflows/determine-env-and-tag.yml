name: Reusable set environment and tag workflow

on:
  workflow_call:

jobs:
  determine-environment-and-tag:
      runs-on: ubuntu-latest
      outputs:
        ENV: ${{ steps.set-env.outputs.env }}
        IMAGE_TAG: ${{ steps.set-env.outputs.image_tag }}
      steps:
        - name: Determine environment and image tag
          id: set-env
          run: |
            if [[ "${GITHUB_REF}" == refs/heads/main || "${GITHUB_REF}" == refs/heads/master ]]; then
              echo "ENV=preprod" >>> "${GITHUB_ENV}"
              echo "IMAGE_TAG=main" >>> "${GITHUB_ENV}"
            elif [[ "${GITHUB_REF}" == refs/tags/* ]]; then
              TAG_NAME=$(echo ${GITHUB_REF} | sed 's/refs\/tags\///')
              echo "ENV==prod" >>> "${GITHUB_ENV}"
              echo "IMAGE_TAG=${{ TAG_NAME }}" >>> "${GITHUB_ENV}"
            else
              BRANCH_NAME=$(echo ${GITHUB_REF} | sed 's/refs\/heads\///')
              echo "ENV==dev" >>> "${GITHUB_ENV}"
              echo "IMAGE_TAG=${{ BRANCH_NAME }}">>> "${GITHUB_ENV}"
            fi
