name: Reusable set environment and tag workflow

on:
  workflow_call:

jobs:
  determine-environment-and-tag:
      runs-on: ubuntu-latest
      outputs:
        ENV: ${{ steps.set-env.outputs.env }}
        IMAGE_TAG: ${{ steps.set-env.outputs.image_tag }}
      steps:
        - name: Determine environment and image tag
          id: set-env
          run: |
            if [[ "${github.ref_name}" == refs/heads/main || "${github.ref_name}" == refs/heads/master ]]; then
              echo "ENV=preprod" >> "${GITHUB_ENV}"
              echo "IMAGE_TAG=main" >> "${GITHUB_ENV}"
            elif [[ "${github.ref_name}" == refs/tags/* ]]; then
              tag_name=$(echo ${github.ref_name} | sed 's/refs\/tags\///')
              echo "ENV==prod" >> "${GITHUB_ENV}"
              echo "IMAGE_TAG=${ tag_name }" >> "${GITHUB_ENV}"
            else
              brunch_name=${github.ref_name#refs/heads/}
              echo "ENV==dev" >> "${GITHUB_ENV}"
              echo "IMAGE_TAG=${ brunch_name }" >> "${GITHUB_ENV}"
            fi
